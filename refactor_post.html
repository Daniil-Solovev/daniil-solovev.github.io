<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Дорабатываем новости, часть 1 | Symfony 4</title>
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

    <link rel="stylesheet" href="css/fonts/default.css">
    <link rel="stylesheet" href="css/symfony/layout.css">
    <link rel="stylesheet" href="css/symfony/styles.css">
    <link rel="stylesheet" href="css/jquery.fancybox.css">

</head>
<body>
<header class="main-header">
    <b class="logo">Symfony 4</b>
    <nav class="main-nav">
        <ul class="main-nav__list">
            <li> <a class="main-nav__link" href="index.html">Home</a> </li>
            <li> <a class="main-nav__link" href="feedback.html">Feedback</a> </li>
            <li> <a class="main-nav__link" href="#">Author</a> </li>
        </ul>
    </nav>
</header>
<main class="main-container">

    <nav class="breadcrumbs">
        <ul class="breadcrumbs__list">
            <li class="breadcrumbs__item">
                <a class="breadcrumbs__link" href="index.html">Symfony</a>
            </li>
            <li class="breadcrumbs__item">
                <a class="breadcrumbs__link" href="#">Completion of posts</a>
            </li>
        </ul>
    </nav>

    <h1 class="visuallyhidden">Completion of posts</h1>

    <section class="symfony refactor">
        <h2>Дорабатываем вывод новостей, часть 1</h2>
        <p class="symfony__text">
            Сейчас новости выводятся из массива, который расположен в <code class="inline-sample">PostController</code>.
            Давайте заполним таблицу. Конечно можно сделать все руками, но мы воспользуемся библиотекой,
            которая все за нас сгенерирует, подключим <code class="inline-sample">composer require fzaninotto/faker</code>.
        </p>

        <p class="symfony__text">
            В PostController добавим свойство <code class="inline-sample">public $fake_post</code>.
            В метод index PostController'a добавим немного когда, который зальет в базу рандомный текст.
        </p>

        <pre class="code-sample">
        <code class="php">
    $this->fake_post = Factory::create();

    $manager = $this->getDoctrine()->getManager();
    for ($i = 1; $i < 20; $i++) {
        $post = new Post();
        $post->setTitle($this->fake_post->text(100));
        $post->setBody($this->fake_post->text(500));
        $post->setLikes(rand(100, 500));
        $manager->persist($post);
    }

    $manager->flush();
        </code>
    </pre>

        <p class="postscriptum">
            Обратите внимание на <code class="inline-sample">use App\Entity\Post</code> и
            <code class="inline-sample">use Faker\Factory</code>. Массив с постами можно пока оставить.

        </p>

        <p class="symfony__text">
            Вот что получилось:
            <a class="fancybox" href="img/symfony/complite_post/faker_example.jpg">
                <img class="symfony-image" src="img/symfony/complite_post/faker_example.jpg" alt="Local server run">
            </a>
        </p>

        <div class="enumeration">
            <p class="enumeration__title">Что здесь происходит?</p>
            <ul class="enumeration__list">
                <li>
                    - с помощью <code class="inline-sample">$manager = $this->getDoctrine()->getManager()</code>
                    мы инициировали менеджер объекта для конкретной сущности, в нашем случае это Post.
                    Он отвечает за сохранение объектов и выборку объектов из базы данных.
                </li>
                <li>
                    - метод <strong>persist()</strong> в контексте <code class="inline-sample">$manager->persist($post)</code>
                    выполняет подготовку запроса.
                </li>
                <li>
                    - метод <strong>flush()</strong> в <code class="inline-sample">$manager->flush()</code> записывает в базу.
                </li>
            </ul>
        </div>

        <p class="symfony__text">
            Осталось только обновить страницу, тем самым вызвав код на исполнение, и убедиться, что все работает.
            Перейдем по маршруту /post (он же главная), тем самым вызвав работу faker. Проверяем БД:
            <a class="fancybox" href="img/symfony/complite_post/fill_database.jpg">
                <img class="symfony-image" src="img/symfony/complite_post/fill_database.jpg" alt="Local server run">
            </a>
            Если все прошло успешно - код faker'a в методе index можно удалить.
        </p>
    </section>

    <hr>

    <section class="symfony news">
        <h2>Вывод всех новостей</h2>
        <p class="symfony__text">
            Когда мы генерировали сущность Post, вместе с ней был создан репозиторий PostRepository.
            С его помощью мы будем составлять запросы к базе данных. Ну и предлагаю сразу же им воспользоваться.
            Теперь массив с новостями смело можно удалять и написать в методе
            <code class="inline-sample">$repository = $this->getDoctrine()->getRepository(Post::class)</code>.
            Теперь нам доступны стандартные методы для выборки findBy, findAll, findOneBy и прочие.
        </p>

        <p class="postscriptum">
            PostController наследуется от AbstractController, и не сразу можно заметить откуда
            у него метод getDoctrine(). Кого-то может ввести в заблуждение, однако это достаточно частая практика.
            Просто ниже используется use ControllerTrait.
        </p>

        <p class="symfony__text">
            Собственно, применим <code class="inline-sample">findAll()</code> к репозиторию и выведем на страницу посты.
            Добавляем в код <code class="inline-sample">$posts = $repository->findAll()</code>.
            Обновляем страницу и наблюдаем свежесгенерированные новости.
            <a class="fancybox" href="img/symfony/complite_post/getdoctrine.jpg">
                <img class="symfony-image" src="img/symfony/complite_post/getdoctrine.jpg" alt="Local server run">
            </a>
        </p>

        <p class="postscriptum">
            <code class="inline-sample">$this->getDoctine()->getRepository(Post::class)</code>
            и <code class="inline-sample">$this->getDoctine()->getManager()->getRepository(Post::class)</code> равносильны.
            <!--        <a href="https://stackoverflow.com/questions/8316006/getentitymanager-and-getdoctrine-in-symfony2">ссылка</a>.-->
        </p>
    </section>

    <section class="symfony current-post">
        <h2>Просмотр одной новости</h2>
        <p class="symfony__text">
            Ранее, с помощью фильтра "truncate" мы ограничили отображаемое количество символов у новости в общем списке.
            Теперь выведем на просмотр конкретную новость. Для этого создадим еще один метод в
            <code class="inline-sample">PostController</code>, назовем его <code class="inline-sample">post</code>.
        </p>

        <pre class="code-sample">
        <code class="php">
    /**
    * @param Post $post
    * @return \Symfony\Component\HttpFoundation\Response
    * @Route("/post/{id}", name="post")
    */
    public function post(Post $post)
    {
        return $this->render('post/show.html.twig', [
            'post' => $post
        ]);
    }
        </code>
    </pre>

        <p class="symfony__text">
            Сначала обратим внимание на аннотации, а конкретно на <code class="inline-sample">@Route</code>.
            После <code class="inline-sample">/post</code> добавился
            параметр <code class="inline-sample">{id}</code>, а в выражении
            <code class="inline-sample">public function post(Post $post)</code> мы получаем конкретный пост.
            Ну и это все. Остается только немного поработать над шаблонами.
        </p>

        <p class="postscriptum">
            Symfony конечно хороший фреймворк, но иногда там происходят паранормальные вещи.
            Например, при попытке просмотра конкретного поста периодически (именно периодически) мне приходилось лизезреть
            ошибку, якобы не существует сервиса Post. Решилось это, не менее странно, обновлением annotations -
            <code class="inline-sample">composer require annotations</code>.
        </p>

        <p class="symfony__text">
            В папке <code class="inline-sample">templates => post</code> создадим шаблон
            <code class="inline-sample">show.html.twig</code>. Код можно взять <a class="symfony-link" href="#">здесь</a>.

            <a class="fancybox" href="img/symfony/complite_post/show_post.jpg">
                <img class="symfony-image" src="img/symfony/complite_post/show_post.jpg" alt="Local server run">
            </a>

            Теперь добавим ссылки под каждый пост в шаблоне <code class="inline-sample">index.html.twig</code>.
            Ссылке <code class="inline-sample">Read more</code> добавляем в аттрибут <code class="inline-sample">href</code>
            <code class="inline-sample">{{ path('post', {'id': post.id}) }}</code>. Проверяем.

            <a class="fancybox" href="img/symfony/complite_post/index_link.jpg">
                <img class="symfony-image" src="img/symfony/complite_post/index_link.jpg" alt="Local server run">
            </a>
        </p>

        <!--    <p class="symfony__text">-->
        <!--        Проверяем работу, переходим на страницу постов и видим ошибку. В чем же тут ошибка?-->
        <!--        Ошибка заключается в параметре <code class="inline-sample">{id}</code>. Посмотрите на-->
        <!--        <code class="inline-sample">@Route</code>,-->
        <!--        в обоих методах маршрут начинается с <code class="inline-sample">/post</code>. И получается что-->
        <!--        <code class="inline-sample">/post/{id}</code>-->
        <!--        отрабатывает, пытается найти id, но мы его не передаем.-->
        <!--    </p>-->


    </section>

    <div class="page-nav">
        <a tabindex="2" href="entity.html" class="page-nav__prev" title="Previous page"></a>
        <a tabindex="1" href="refactor_post2.html" class="page-nav__next" title="Nex page"></a>
    </div>

</main>
<!--<footer>-->
<!--    Footer-->
<!--</footer>-->
<script src="js/jquery.js"></script>
<script src="js/jquery.fancybox.pack.js"></script>
<script src="js/highlight.pack.js"></script>
<script src="js/script.js"></script>
</body>
</html>